<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Study Crew - ì¼ì • ì¡°ìœ¨</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            padding: 60px 20px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 980px;
            margin: 0 auto;
        }

        h1 {
            color: #1d1d1f;
            margin-bottom: 8px;
            font-size: 56px;
            font-weight: 600;
            letter-spacing: -0.015em;
            text-align: center;
        }

        .subtitle {
            color: #6e6e73;
            margin-bottom: 60px;
            font-size: 21px;
            font-weight: 400;
            text-align: center;
            letter-spacing: 0.011em;
        }

        .section {
            margin-bottom: 80px;
        }

        .section h2 {
            color: #1d1d1f;
            margin-bottom: 32px;
            font-size: 32px;
            font-weight: 600;
            letter-spacing: -0.005em;
            text-align: center;
        }

        .members-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            max-width: 800px;
            margin: 0 auto;
        }

        .member-card {
            background: white;
            padding: 24px 16px;
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #d2d2d7;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .member-card:hover {
            border-color: #0071e3;
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }

        .member-card.selected {
            background: #0071e3;
            border-color: #0071e3;
            box-shadow: 0 4px 16px rgba(0, 113, 227, 0.25);
        }

        .member-card.selected .member-name {
            color: white;
        }

        .member-name {
            font-weight: 500;
            color: #1d1d1f;
            font-size: 17px;
            letter-spacing: -0.022em;
        }

        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .schedule-table th,
        .schedule-table td {
            padding: 16px 20px;
            text-align: center;
            border-bottom: 1px solid #d2d2d7;
        }

        .schedule-table th {
            background: #fbfbfd;
            color: #1d1d1f;
            font-weight: 600;
            font-size: 15px;
            letter-spacing: -0.016em;
        }

        .schedule-table tbody tr:hover {
            background: #f5f5f7;
        }

        .schedule-table tbody tr:last-child td {
            border-bottom: none;
        }

        .date-header {
            background: #fbfbfd !important;
        }

        .attendance-count {
            font-size: 17px;
            font-weight: 600;
            color: #0071e3;
        }

        .result-box {
            background: white;
            padding: 48px 32px;
            border-radius: 18px;
            margin-top: 60px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .result-box h3 {
            font-size: 21px;
            margin-bottom: 16px;
            color: #6e6e73;
            font-weight: 500;
        }

        .result-box .best-date-text {
            font-size: 40px;
            font-weight: 600;
            margin: 16px 0;
            color: #1d1d1f;
            letter-spacing: -0.015em;
        }

        .result-box .attendance-text {
            font-size: 19px;
            color: #6e6e73;
            font-weight: 400;
        }

        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: #86868b;
            font-size: 17px;
        }

        .date-input-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .date-card {
            background: white;
            padding: 28px 40px;
            border-radius: 18px;
            border: 2px solid #d2d2d7;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            min-width: 140px;
        }

        .date-card:hover {
            border-color: #0071e3;
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }

        .date-card.selected {
            background: #0071e3;
            border-color: #0071e3;
            box-shadow: 0 4px 16px rgba(0, 113, 227, 0.25);
        }

        .date-card.selected .date-text {
            color: white;
        }

        .date-card.selected .day-text {
            color: rgba(255, 255, 255, 0.8);
        }

        .date-text {
            font-weight: 600;
            font-size: 28px;
            color: #1d1d1f;
            margin-bottom: 4px;
            letter-spacing: -0.015em;
        }

        .day-text {
            font-size: 15px;
            color: #86868b;
            font-weight: 400;
        }

        .manage-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .manage-btn {
            background: transparent;
            color: #0071e3;
            border: 2px solid #0071e3;
            padding: 10px 24px;
            font-size: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .manage-btn:hover {
            background: #0071e3;
            color: white;
            transform: scale(1.02);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 18px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #1d1d1f;
        }

        .modal-input-group {
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #d2d2d7;
            border-radius: 12px;
            font-size: 17px;
            transition: all 0.3s;
        }

        .modal-input:focus {
            outline: none;
            border-color: #0071e3;
        }

        .modal-members-list {
            margin-bottom: 24px;
        }

        .modal-member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: #f5f5f7;
            border-radius: 12px;
        }

        .modal-member-name {
            font-size: 17px;
            color: #1d1d1f;
        }

        .delete-btn {
            background: #ff3b30;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #e02d1f;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn-primary {
            background: #0071e3;
            color: white;
            border: none;
        }

        .modal-btn-primary:hover {
            background: #0062cc;
        }

        .modal-btn-secondary {
            background: transparent;
            color: #0071e3;
            border: 2px solid #0071e3;
        }

        .modal-btn-secondary:hover {
            background: #f5f5f7;
        }

        .submit-section {
            text-align: center;
            margin-top: 40px;
            margin-bottom: 80px;
        }

        .submit-btn {
            background: #0071e3;
            color: white;
            border: none;
            padding: 16px 48px;
            font-size: 17px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 16px rgba(0, 113, 227, 0.25);
        }

        .submit-btn:hover {
            background: #0062cc;
            transform: scale(1.02);
        }

        .submit-btn:disabled {
            background: #d2d2d7;
            cursor: not-allowed;
            box-shadow: none;
        }

        .edit-btn {
            background: transparent;
            color: #0071e3;
            border: 2px solid #0071e3;
            padding: 8px 20px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 8px;
        }

        .edit-btn:hover {
            background: #0071e3;
            color: white;
            transform: scale(1.02);
        }

        .member-name-cell {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .not-submitted-row {
            background: #f5f5f7 !important;
            opacity: 0.7;
        }

        .not-submitted-cell {
            color: #86868b;
            font-style: italic;
        }

        .unavailable-card {
            background: white;
            padding: 28px 40px;
            border-radius: 18px;
            border: 2px solid #ff3b30;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            min-width: 140px;
        }

        .unavailable-card:hover:not(.disabled) {
            border-color: #ff3b30;
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(255, 59, 48, 0.25);
        }

        .unavailable-card.selected {
            background: #ff3b30;
            border-color: #ff3b30;
            box-shadow: 0 4px 16px rgba(255, 59, 48, 0.4);
        }

        .unavailable-card.selected .unavailable-text {
            color: white;
        }

        .unavailable-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #d2d2d7;
        }

        .unavailable-text {
            font-weight: 600;
            font-size: 17px;
            color: #ff3b30;
            letter-spacing: -0.015em;
        }

        .copy-btn {
            background: #34c759;
            color: white;
            border: none;
            padding: 12px 28px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            margin-left: 12px;
        }

        .copy-btn:hover {
            background: #2da84a;
            transform: scale(1.02);
        }

        .copy-btn:disabled {
            background: #d2d2d7;
            cursor: not-allowed;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>AI Study Crew</h1>
        <p class="subtitle">ë§¤ì£¼ ëª¨ì„ ì¼ì •ì„ ì‰½ê²Œ ì¡°ìœ¨í•˜ì„¸ìš”.</p>

        <div class="manage-section">
            <button class="manage-btn" onclick="openManageModal()">ë©¤ë²„ ê´€ë¦¬</button>
        </div>

        <div class="section">
            <h2>ë³¸ì¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
            <div class="members-list" id="membersList"></div>
        </div>

        <div class="section">
            <h2>ì°¸ì„ ê°€ëŠ¥í•œ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
            <div class="date-input-group" id="datesListContainer"></div>
        </div>

        <div class="submit-section">
            <button class="submit-btn" id="submitBtn" onclick="submitSelection()" disabled>ì…ë ¥ ì™„ë£Œ</button>
        </div>

        <div class="section">
            <h2>ì°¸ì„ í˜„í™©</h2>
            <div id="scheduleTableContainer"></div>
        </div>

        <div id="resultBox"></div>
    </div>

    <!-- ë©¤ë²„ ê´€ë¦¬ ëª¨ë‹¬ -->
    <div class="modal" id="manageModal">
        <div class="modal-content">
            <h2 class="modal-header">ë©¤ë²„ ê´€ë¦¬</h2>

            <div class="modal-input-group">
                <input type="text" class="modal-input" id="newMemberInput" placeholder="ìƒˆ ë©¤ë²„ ì´ë¦„" />
            </div>

            <button class="modal-btn modal-btn-primary" onclick="addNewMember()" style="width: 100%; margin-bottom: 24px;">ë©¤ë²„ ì¶”ê°€</button>

            <div class="modal-members-list" id="modalMembersList"></div>

            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeManageModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz2CCEL-5_-BHuSrVxEzSyQGmoFEfXyPGniQ_spVDmeBmtxoBajTboZuo_xK9ngyHIv7A/exec';

        // ë©¤ë²„ ëª©ë¡
        let allMembers = ['ê¹€ê·¼ì•„', 'ë‚˜í¬ì§„', 'ì´ìƒìš©', 'ì´ì˜ˆì§„', 'ì´ìš©ì„±', 'ì¡°ì¸ì£¼', 'í™©ì„±ìš±'];

        let selectedMember = null;
        let selectedDates = [];
        let availability = {};
        let submittedMembers = {}; // ì…ë ¥ì„ ì™„ë£Œí•œ ë©¤ë²„ ì¶”ì 

        // ì´ë²ˆ ì£¼ ìˆ˜, ëª©, ê¸ˆ ë‚ ì§œ ê³„ì‚° (ìš”ì¼ ê¸°ë°˜)
        function getThisWeekDates() {
            const today = new Date();
            const currentDay = today.getDay(); // 0: ì¼ìš”ì¼, 1: ì›”ìš”ì¼, ...
            const dates = [];

            // ìˆ˜ìš”ì¼(3), ëª©ìš”ì¼(4), ê¸ˆìš”ì¼(5)
            const targetDays = [
                { day: 3, name: 'ìˆ˜ìš”ì¼', key: 'wed' },
                { day: 4, name: 'ëª©ìš”ì¼', key: 'thu' },
                { day: 5, name: 'ê¸ˆìš”ì¼', key: 'fri' }
            ];

            targetDays.forEach(target => {
                const diff = target.day - currentDay;
                const targetDate = new Date(today);
                targetDate.setDate(today.getDate() + diff);

                const month = targetDate.getMonth() + 1;
                const day = targetDate.getDate();

                dates.push({
                    value: target.key, // ìš”ì¼ í‚¤ë¡œ ë³€ê²½ (wed, thu, fri)
                    display: `${month}ì›” ${day}ì¼`,
                    dayName: target.name
                });
            });

            return dates;
        }

        const weekDates = getThisWeekDates();

        // Google Sheetsì—ì„œ ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                const response = await fetch(SCRIPT_URL + '?action=load');
                const data = await response.json();

                if (data.success) {
                    if (data.members) allMembers = data.members;
                    if (data.availability) availability = data.availability;
                    if (data.submittedMembers) submittedMembers = data.submittedMembers;
                }
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }

            // ì´ˆê¸° ë Œë”ë§
            selectedMember = null;
            selectedDates = [];
            renderMembers();
            renderDates();
            renderScheduleTable();
            updateBestDate();

            // 5ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨ (ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë³€ê²½ì‚¬í•­ ê°ì§€)
            setInterval(async () => {
                try {
                    const response = await fetch(SCRIPT_URL + '?action=load');
                    const data = await response.json();

                    if (data.success) {
                        if (data.members) allMembers = data.members;
                        if (data.availability) availability = data.availability;
                        if (data.submittedMembers) submittedMembers = data.submittedMembers;

                        renderMembers();
                        renderScheduleTable();
                        updateBestDate();
                    }
                } catch (error) {
                    console.error('ìë™ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
                }
            }, 5000);
        }

        // Google Sheetsì— ë°ì´í„° ì €ì¥
        async function saveData() {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save',
                        members: allMembers,
                        availability: availability,
                        submittedMembers: submittedMembers
                    })
                });

                console.log('ë°ì´í„° ì €ì¥ ì™„ë£Œ');
            } catch (error) {
                console.error('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        // ë©¤ë²„ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
        function openManageModal() {
            document.getElementById('manageModal').classList.add('active');
            renderModalMembers();
        }

        // ë©¤ë²„ ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
        function closeManageModal() {
            document.getElementById('manageModal').classList.remove('active');
            document.getElementById('newMemberInput').value = '';
        }

        // ëª¨ë‹¬ ë©¤ë²„ ëª©ë¡ ë Œë”ë§
        function renderModalMembers() {
            const container = document.getElementById('modalMembersList');

            if (allMembers.length === 0) {
                container.innerHTML = '<div class="empty-state">ë“±ë¡ëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            container.innerHTML = allMembers.map(member => `
                <div class="modal-member-item">
                    <span class="modal-member-name">${member}</span>
                    <button class="delete-btn" onclick="deleteMember('${member}')">ì‚­ì œ</button>
                </div>
            `).join('');
        }

        // ìƒˆ ë©¤ë²„ ì¶”ê°€
        function addNewMember() {
            const input = document.getElementById('newMemberInput');
            const name = input.value.trim();

            if (!name) {
                alert('ë©¤ë²„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (allMembers.includes(name)) {
                alert('ì´ë¯¸ ë“±ë¡ëœ ë©¤ë²„ì…ë‹ˆë‹¤.');
                return;
            }

            allMembers.push(name);
            input.value = '';
            saveData();
            renderModalMembers();
            renderMembers();
            renderScheduleTable();
            updateBestDate();
        }

        // ë©¤ë²„ ì‚­ì œ
        function deleteMember(name) {
            if (!confirm(`${name}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ ë©¤ë²„ì˜ ëª¨ë“  ì°¸ì„ ì •ë³´ê°€ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                return;
            }

            allMembers = allMembers.filter(m => m !== name);

            // ì„ íƒëœ ë©¤ë²„ì˜€ë‹¤ë©´ ì„ íƒ í•´ì œ
            if (selectedMember === name) {
                selectedMember = null;
            }

            // í•´ë‹¹ ë©¤ë²„ì˜ ì°¸ì„ ì •ë³´ ì‚­ì œ
            for (let date in availability) {
                if (availability[date][name]) {
                    delete availability[date][name];
                }
            }

            // ì…ë ¥ ì™„ë£Œ ìƒíƒœ ì‚­ì œ
            if (submittedMembers[name]) {
                delete submittedMembers[name];
            }

            saveData();
            renderModalMembers();
            renderMembers();
            renderScheduleTable();
            updateBestDate();
        }

        // Enter í‚¤ë¡œ ë©¤ë²„ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('newMemberInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addNewMember();
                }
            });

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
            document.getElementById('manageModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeManageModal();
                }
            });
        });

        // ë©¤ë²„ ì„ íƒ
        function selectMember(name) {
            selectedMember = name;
            updateSubmitButton();
            updateUnavailableButton();
            renderMembers();
        }

        // ë©¤ë²„ ëª©ë¡ ë Œë”ë§
        function renderMembers() {
            const container = document.getElementById('membersList');

            container.innerHTML = allMembers.map(member => `
                <div class="member-card ${selectedMember === member ? 'selected' : ''}" onclick="selectMember('${member}')">
                    <span class="member-name">${member}</span>
                </div>
            `).join('');
        }

        // ë‚ ì§œ í† ê¸€
        function toggleDate(dateValue) {
            if (!selectedMember) {
                alert('ë¨¼ì € ë³¸ì¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const index = selectedDates.indexOf(dateValue);
            if (index > -1) {
                selectedDates.splice(index, 1);
            } else {
                selectedDates.push(dateValue);
                // ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ "ëª¨ë“  ë‚ ì§œ ë¶ˆê°€ëŠ¥" ì„ íƒ í•´ì œ
                const unavailableCard = document.getElementById('unavailableCard');
                if (unavailableCard) {
                    unavailableCard.classList.remove('selected');
                }
            }

            updateSubmitButton();
            renderDates();
        }

        // ë‚ ì§œ ëª©ë¡ ë Œë”ë§
        function renderDates() {
            const container = document.getElementById('datesListContainer');

            const datesHtml = weekDates.map(date => `
                <div class="date-card ${selectedDates.includes(date.value) ? 'selected' : ''}" onclick="toggleDate('${date.value}')">
                    <div class="date-text">${date.display}</div>
                    <div class="day-text">${date.dayName}</div>
                </div>
            `).join('');

            const isUnavailableSelected = selectedMember && selectedDates.length === 0 && document.getElementById('unavailableCard')?.classList.contains('selected');
            const unavailableHtml = `
                <div class="unavailable-card ${!selectedMember ? 'disabled' : ''} ${isUnavailableSelected ? 'selected' : ''}"
                     id="unavailableCard"
                     onclick="toggleUnavailable()">
                    <div class="unavailable-text">ëª¨ë“  ë‚ ì§œ<br>ë¶ˆê°€ëŠ¥</div>
                </div>
            `;

            container.innerHTML = datesHtml + unavailableHtml;
        }

        // ë‚ ì§œ í˜•ì‹ ë³€í™˜ (ìš”ì¼ í‚¤ ê¸°ë°˜)
        function formatDate(dayKey) {
            // ìš”ì¼ í‚¤ì— í•´ë‹¹í•˜ëŠ” ì‹¤ì œ ë‚ ì§œ ì°¾ê¸°
            const dateInfo = weekDates.find(d => d.value === dayKey);
            if (dateInfo) {
                return `${dateInfo.display} (${dateInfo.dayName})`;
            }
            return dayKey; // fallback
        }

        // ìŠ¤ì¼€ì¤„ í…Œì´ë¸” ë Œë”ë§
        function renderScheduleTable() {
            const container = document.getElementById('scheduleTableContainer');

            // ëª¨ë“  ë‚ ì§œì— ëŒ€í•œ ì°¸ì„ í˜„í™© í‘œì‹œ (ì„ íƒí•˜ì§€ ì•Šì€ ë‚ ì§œë„ í¬í•¨)
            const allDates = weekDates.map(d => d.value);

            // ê° ë‚ ì§œë³„ ì°¸ì„ ê°€ëŠ¥ ì¸ì› ê³„ì‚°
            const dateCounts = {};
            allDates.forEach(date => {
                dateCounts[date] = 0;
                allMembers.forEach(member => {
                    if (availability[date] && availability[date][member]) {
                        dateCounts[date]++;
                    }
                });
            });

            let html = '<table class="schedule-table">';

            // í—¤ë”
            html += '<thead><tr><th>ë©¤ë²„</th>';
            allDates.forEach(date => {
                html += `<th class="date-header">${formatDate(date)}</th>`;
            });
            html += '</tr></thead>';

            // ë©¤ë²„ë³„ ì°¸ì„ ì—¬ë¶€
            html += '<tbody>';
            allMembers.forEach(member => {
                const isCurrentUser = member === selectedMember;
                const hasSubmitted = submittedMembers[member];

                let rowStyle = '';
                if (isCurrentUser) {
                    rowStyle = 'background: #fff3cd;';
                } else if (!hasSubmitted) {
                    rowStyle = 'class="not-submitted-row"';
                }

                html += `<tr ${rowStyle}>
                    <td>
                        <div class="member-name-cell">
                            <strong>${member}${isCurrentUser ? ' (ë‚˜)' : ''}</strong>
                            <button class="edit-btn" onclick="editMemberSchedule('${member}')">ìˆ˜ì •</button>
                        </div>
                    </td>`;

                if (!hasSubmitted) {
                    // ë¯¸ì…ë ¥ ìƒíƒœ
                    html += `<td colspan="${allDates.length}" class="not-submitted-cell">ë¯¸ì…ë ¥</td>`;
                } else {
                    // ì…ë ¥ ì™„ë£Œ ìƒíƒœ
                    allDates.forEach(date => {
                        const isAvailable = availability[date] && availability[date][member];
                        html += `<td>${isAvailable ? 'âœ“' : '-'}</td>`;
                    });
                }
                html += '</tr>';
            });

            // ì°¸ì„ ê°€ëŠ¥ ì¸ì› í•©ê³„
            html += '<tr style="background: #f8f9fa; font-weight: bold;"><td>ì°¸ì„ ê°€ëŠ¥ ì¸ì›</td>';
            allDates.forEach(date => {
                html += `<td class="attendance-count">${dateCounts[date]} / ${allMembers.length}</td>`;
            });
            html += '</tr>';

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ìµœì ì˜ ë‚ ì§œ ê³„ì‚° ë° í‘œì‹œ
        function updateBestDate() {
            const resultBox = document.getElementById('resultBox');

            const allDates = weekDates.map(d => d.value);

            // ê° ë‚ ì§œë³„ ì°¸ì„ ê°€ëŠ¥ ì¸ì› ê³„ì‚°
            let maxCount = 0;
            let bestDates = [];

            allDates.forEach(date => {
                let count = 0;
                allMembers.forEach(member => {
                    if (availability[date] && availability[date][member]) {
                        count++;
                    }
                });

                if (count > maxCount) {
                    maxCount = count;
                    bestDates = [date];
                } else if (count === maxCount && count > 0) {
                    bestDates.push(date);
                }
            });

            if (maxCount === 0) {
                resultBox.innerHTML = `
                    <div class="result-box">
                        <h3>ì•„ì§ ì°¸ì„ ê°€ëŠ¥í•œ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p class="attendance-text">ì°¸ì„ ê°€ëŠ¥í•œ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }

            const bestDatesText = bestDates.map(d => formatDate(d)).join(', ');

            resultBox.innerHTML = `
                <div class="result-box">
                    <h3>ìµœì ì˜ ëª¨ì„ ë‚ ì§œ</h3>
                    <div class="best-date-text">${bestDatesText}</div>
                    <p class="attendance-text">${maxCount}ëª… / ${allMembers.length}ëª… ì°¸ì„ ê°€ëŠ¥</p>
                    <button class="copy-btn" onclick="copyToClipboard()">ğŸ“‹ ì¼ì • ë³µì‚¬</button>
                </div>
            `;
        }

        // ì…ë ¥ ì™„ë£Œ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ì—…ë°ì´íŠ¸
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            // ë©¤ë²„ê°€ ì„ íƒë˜ê³  ìµœì†Œ 1ê°œ ì´ìƒì˜ ë‚ ì§œê°€ ì„ íƒë˜ì—ˆì„ ë•Œ í™œì„±í™”
            if (selectedMember && selectedDates.length > 0) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        // ëª¨ë“  ë‚ ì§œ ë¶ˆê°€ëŠ¥ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ì—…ë°ì´íŠ¸
        function updateUnavailableButton() {
            // renderDates()ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ë³„ë„ ì—…ë°ì´íŠ¸ ë¶ˆí•„ìš”
        }

        // ëª¨ë“  ë‚ ì§œ ë¶ˆê°€ëŠ¥ í† ê¸€
        function toggleUnavailable() {
            if (!selectedMember) {
                alert('ë¨¼ì € ë³¸ì¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const unavailableCard = document.getElementById('unavailableCard');
            const isCurrentlySelected = unavailableCard.classList.contains('selected');

            if (isCurrentlySelected) {
                // ì„ íƒ í•´ì œ
                unavailableCard.classList.remove('selected');
                updateSubmitButton();
            } else {
                // ëª¨ë“  ë‚ ì§œ ì„ íƒ í•´ì œí•˜ê³  ë¶ˆê°€ëŠ¥ ì„ íƒ
                selectedDates = [];
                unavailableCard.classList.add('selected');

                // ì…ë ¥ ì™„ë£Œ ë²„íŠ¼ í™œì„±í™”
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = false;
            }

            renderDates();
        }

        // ì…ë ¥ ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
        function submitSelection() {
            if (!selectedMember) {
                return;
            }

            // ë¨¼ì € í•´ë‹¹ ë©¤ë²„ì˜ ê¸°ì¡´ ì°¸ì„ ì •ë³´ë¥¼ ëª¨ë‘ ì‚­ì œ
            weekDates.forEach(date => {
                if (availability[date.value] && availability[date.value][selectedMember]) {
                    delete availability[date.value][selectedMember];
                }
            });

            // ì„ íƒí•œ ë‚ ì§œë¥¼ availabilityì— ì €ì¥ (ë‚ ì§œê°€ ì—†ìœ¼ë©´ ëª¨ë‘ ë¶ˆê°€ëŠ¥)
            selectedDates.forEach(dateValue => {
                if (!availability[dateValue]) {
                    availability[dateValue] = {};
                }
                availability[dateValue][selectedMember] = true;
            });

            // ì…ë ¥ ì™„ë£Œ ìƒíƒœë¡œ í‘œì‹œ
            submittedMembers[selectedMember] = true;

            saveData();

            // ì„ íƒ ì´ˆê¸°í™”
            selectedMember = null;
            selectedDates = [];

            renderMembers();
            renderDates();
            renderScheduleTable();
            updateBestDate();
            updateSubmitButton();
            updateUnavailableButton();

            alert('ì…ë ¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ë©¤ë²„ ì¼ì • ìˆ˜ì • ê¸°ëŠ¥
        function editMemberSchedule(memberName) {
            // í•´ë‹¹ ë©¤ë²„ë¡œ ì„ íƒ
            selectedMember = memberName;

            // í˜„ì¬ í•´ë‹¹ ë©¤ë²„ê°€ ì„ íƒí•œ ë‚ ì§œë“¤ì„ ê°€ì ¸ì˜´
            selectedDates = [];
            weekDates.forEach(date => {
                if (availability[date.value] && availability[date.value][memberName]) {
                    selectedDates.push(date.value);
                }
            });

            // UI ì—…ë°ì´íŠ¸
            renderMembers();
            renderDates();
            updateSubmitButton();
            updateUnavailableButton();

            // í˜ì´ì§€ ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            window.scrollTo({ top: 0, behavior: 'smooth' });

            alert(`${memberName}ì˜ ì¼ì •ì„ ìˆ˜ì •í•©ë‹ˆë‹¤.\në‚ ì§œë¥¼ ë‹¤ì‹œ ì„ íƒí•œ í›„ "ì…ë ¥ ì™„ë£Œ"ë¥¼ í´ë¦­í•˜ì„¸ìš”.`);
        }

        // í´ë¦½ë³´ë“œì— ì¼ì • ë³µì‚¬
        async function copyToClipboard() {
            // ìµœì ì˜ ë‚ ì§œ ê³„ì‚°
            const allDates = weekDates.map(d => d.value);
            let maxCount = 0;
            let bestDates = [];

            allDates.forEach(date => {
                let count = 0;
                allMembers.forEach(member => {
                    if (availability[date] && availability[date][member]) {
                        count++;
                    }
                });

                if (count > maxCount) {
                    maxCount = count;
                    bestDates = [date];
                } else if (count === maxCount && count > 0) {
                    bestDates.push(date);
                }
            });

            if (maxCount === 0) {
                alert('ì•„ì§ ì°¸ì„ ê°€ëŠ¥í•œ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const bestDatesText = bestDates.map(d => formatDate(d)).join(', ');

            // ì°¸ì„ ê°€ëŠ¥í•œ ë©¤ë²„ ëª©ë¡
            const attendeesList = [];
            bestDates.forEach(date => {
                allMembers.forEach(member => {
                    if (availability[date] && availability[date][member]) {
                        if (!attendeesList.includes(member)) {
                            attendeesList.push(member);
                        }
                    }
                });
            });

            // ë³µì‚¬í•  í…ìŠ¤íŠ¸ ìƒì„±
            const textToCopy = `ğŸ“… AI Study Crew ëª¨ì„ ì¼ì •

ë‚ ì§œ: ${bestDatesText}
ì°¸ì„ ì¸ì›: ${maxCount}ëª… / ${allMembers.length}ëª…
ì°¸ì„ ê°€ëŠ¥ ë©¤ë²„: ${attendeesList.join(', ')}`;

            try {
                await navigator.clipboard.writeText(textToCopy);
                alert('ì¼ì •ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹\nì›í•˜ëŠ” ê³³ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)í•˜ì„¸ìš”.');
            } catch (error) {
                // í´ë¦½ë³´ë“œ APIê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš° fallback
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    alert('ì¼ì •ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹\nì›í•˜ëŠ” ê³³ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)í•˜ì„¸ìš”.');
                } catch (err) {
                    alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    console.error('ë³µì‚¬ ì˜¤ë¥˜:', err);
                }
                document.body.removeChild(textarea);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
        loadData();
    </script>
</body>
</html>
